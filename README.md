# X-Grid & X-Grid Styler

**国有林の現場で使われる「平均集材距離計算表」を、DX化したシステムです。**

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

![X-Grid アプリケーションのスクリーンショット](https://raw.githubusercontent.com/MitsunobuSuhara/X_Grid4You/main/images/X_Grid-Image.png) 

`X-Grid`は、スタンドアロンで動作するデスクトップアプリケーションです。伐採区域などのベクターデータを読み込み、地図上で土場及び区域の入口を指定することにより、平均集材距離を自動で算出します。計算結果は、計算過程がひと目でわかる図としてPDFに出力できます。

`X-Grid Styler`は、オープンソースGISソフトウェア「QGIS」のプラグインです。QGIS上で作成した地図の見た目（色、線の種類、太さなど）を`X-Grid`アプリに引き継ぐためのスタイル情報を、データに書き出す役割を担います。

## 主な機能 (Key Features)

### X-Grid
- **簡単操作**: わずか数クリックで平均集材距離を計算。
- **データ読み込み**: シェープファイル (`.shp`) や GeoPackage (`.gpkg`) に対応。
- **直感的なインターフェース**: 地図上で土場及び区域の入口（ゼロ距離地点）を直接クリックして指定。
- **自動レイアウト**: 読み込んだデータの形状に合わせて、用紙サイズ (A4/A3) や地図の向きを自動で最適化。
- **詳細な計算表**: 計算の過程がわかる縦横の度数分布表を自動生成。
- **高品質なPDF出力**: 縮尺 1:5000 の計算図を、いつでも印刷できる形式でエクスポート。

### X-Grid Styler (QGIS プラグイン)
- **スタイルの書き出し**: QGISで設定したベクターレイヤのシンボル情報を、属性データとして簡単に書き出します。
- **見た目の再現**: 書き出したデータを`X-Grid`で読み込むと、QGIS上の見た目（ポリゴンの塗りつぶし色、ラインの色や太さなど）が再現されます。
- **多様なレンダラーに対応**: 単一定義、カテゴリ値による定義、ルールに基づいた定義など、QGISの主要なスタイリング方法に対応。

## ワークフロー (Typical Workflow)

---
💡 **このワークフローのゴール:**
計算に必要なすべてのレイヤ（区域、路網、土場など）を、**一つのGeoPackageファイル**にまとめます。この方法なら、ファイル管理が非常にシンプルになります。

### **Step 1: プロジェクト用GeoPackageを作成する**
**森林管理署ごとなどの広域なデータから、計算したい林小班だけを抽出し、このプロジェクトの「マスターファイル」を作成します。**

1.  QGISに、森林管理署単位などの広域な林小班データを読み込みます。
2.  QGISの「地物選択」ツールを使い、計算対象としたい林小班ポリゴンを選択します。
3.  選択した状態で、レイヤ名を右クリックし、「エクスポート」 > 「選択地物の保存...」を選びます。
4.  表示された画面で、以下の設定を行います。
    -   **形式:** **`GeoPackage`** を選択します。
    -   **ファイル名:** このプロジェクトのマスターファイルとして、分かりやすい名前を付けて保存します。（例: `X_Grid-〇〇林班.gpkg`）
    -   **レイヤ名:** `対象区域` など、分かりやすい名前を入力します。
    -   **CRS:** データの座標系（平面直角座標系）を選択します。
5.  [OK]を押すと、選択した林小班だけの、新しいGeoPackageファイルが作成されます。

### **Step 2: 路網や土場レイヤを準備し、プロジェクトに追加する**
**既存の路網データを切り抜くか、新しい路網・土場をデジタイズ（作図）し、Step 1で作成したGeoPackageに追加します。**

#### **【A】既存の路網データを使う場合**
1.  QGISに、広域な作業道などの路網データを読み込みます。
2.  メニューの「プロセシング」 > 「ツールボックス」から**「クリップ」**ツールを起動します。
3.  以下の設定で、区域の形に合わせて路網を切り抜きます。
    -   **入力レイヤ:** 切り抜きたい路網データのレイヤ。
    -   **オーバーレイレイヤ:** **Step 1で作成した区域のレイヤ**。
    -   **クリップ済み:** [**GeoPackageに保存...**] を選択し、**Step 1で作成したマスターファイル**（例: `X_Grid-〇〇林班.gpkg`）を選び、`路網` という新しいレイヤ名で保存します。
4.  [実行]を押すと、マスターファイルの中に、切り抜かれた路網レイヤが追加されます。

#### **【B】新しい路網や土場をデジタイズ（作図）する場合**
1.  QGISのメニューから「レイヤ」 > 「レイヤを作成」 > 「新規GeoPackageレイヤ...」を選択します。
2.  表示された画面で、以下の設定を行います。
    -   **データベース:** [**...**] ボタンを押し、**Step 1で作成したマスターファイル**（例: `〇〇林班プロジェクト.gpkg`）を選択します。` や `
    -   **テーブル/レイヤ名:** `林道、土場` など、新しいレイヤの名前を入力します。
    -   **ジオメトリタイプ:** `ポリゴン`や`ライン` 、 `ポイント` を選択します。
3.  [OK]を押すと、マスターファイルの中に、空の新しいレイヤが追加されます。
4.  そのレイヤを編集モードにして、新しい路網や土場の位置を作図します。

### **Step 3: スタイルを設定し、X-Grid Stylerで書き出す**
1.  プロジェクトGeoPackageに含まれる**すべてのレイヤ**（区域、路網、土場など）のスタイル（色や線の太さなど）を、QGISでお好みに設定します。
2.  QGISプラグイン「X-Grid Styler」を起動します。
3.  ドロップダウンリストから、スタイルを書き出したいレイヤを一つ選択し、「書き出し」ボタンを押します。
4.  **この操作を、プロジェクトGeoPackageに含まれるすべてのレイヤに対して、一つずつ繰り返します。**

### **Step 4: 平均集材距離を計算・出力 (X-Grid)**
1.  スタンドアロンアプリ「X-Grid」を起動します。
2.  `[レイヤ追加]` ボタンから、**Step 1で作成したマスターファイル**（例: `〇〇林班プロジェクト.gpkg`）**一つだけ**を選択します。
3.  レイヤ選択ダイアログが表示されるので、表示したいレイヤにチェックを入れて[OK]を押します。
4.  地図が表示されたら、土場となるセルをクリックして指定します。
5.  `[計算を実行]` ボタンをクリックすると、平均集材距離と計算過程の表が表示されます。
6.  必要に応じて「林小班名等」を入力し、`[表示]` ボタンでタイトルを更新します。
7.  `[エクスポート]` ボタンで、最終的な結果をPDFとして保存します。

---

## インストール (Installation)

**最新版のインストーラーとプラグインは、以下のリンクからダウンロードできます。**
-   **[>> 最新バージョンのダウンロードページはこちら <<](https://github.com/MitsunobuSuhara/X_Grid4You/releases/latest)**

### X-Grid (本体アプリ)
1. 上のリンクから、最新リリースの `X_Grid_vX.X.X_setup.exe` をダウンロードします。
2. ダウンロードしたインストーラーを実行し、画面の指示に従ってインストールしてください。
3. インストールが完了すると、デスクトップやスタートメニューにショートカットが作成されます。

### X-Grid Styler (QGIS プラグイン)
1. 上のリンクから、最新リリースの `x_grid_styler.zip` をダウンロードします。
2. QGISを起動し、メニューから `[プラグイン]` > `[プラグインの管理とインストール]` を開きます。
3. `[ZIPからインストール]` タブを選択し、ダウンロードした `x_grid_styler.zip` を指定してインストールします。
4. ツールバーに新しいアイコンが追加されれば成功です。

## 入力データに関する重要事項
- **座標系**: データは **平面直角座標系** である必要があります。緯度経度のデータでは正しく計算できません。
- **ファイル形式とフィールド名**: シェープファイルの属性名（フィールド名）は**10文字以内**にする必要があります。**GeoPackage (`.gpkg`) 形式で保存**することを強く推奨します。
- **ライン延長の表示**: ラインレイヤの属性に `meter` というフィールド（半角小文字）があると、その値が地図上のラインの横に自動で表示されます（例: `123m`）。

## 技術スタック (Tech Stack)

- **X-Grid**: Python, PyQt6, Fiona, Shapely
- **X-Grid Styler**: Python, PyQGIS API
- **Installer**: Inno Setup

## ライセンス (License)

このプロジェクトはMITライセンスの下で公開されています。詳細は `LICENSE` ファイルをご覧ください。

## 免責事項 (Disclaimer)

本ソフトウェアの使用によって生じたいかなる損害についても、開発者は一切の責任を負いません。計算結果は、業務上の判断を補助するための参考値としてご利用ください。

## 作者 (Author)

- Mitsunobu Suhara + Google AI Studio 
