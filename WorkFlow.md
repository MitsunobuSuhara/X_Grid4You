# X-Grid & X-Grid Styler 開発・リリース作業マニュアル【最終完全版】

このマニュアルは、`X_Grid`アプリ本体と`X-Grid Styler` QGISプラグインの開発から、新しいバージョンの配布ファイルをGitHubにリリースするまでの一連の作業手順と、典型的なトラブルシューティングを網羅したものです。

---

## Part 0: 初期セットアップ（PCごとに最初の一回だけ）

新しい開発環境を整える際に、最初に行うべき設定です。

### 1. Git LFS (Large File Storage) のインストール

-   **目的:** 25MBを超える大きなファイル（インストーラーなど）をGitHubにアップロードできるようにするためのGit拡張機能です。
-   **手順:**
    1.  [Git LFSの公式サイト](https://git-lfs.com/)からインストーラーをダウンロードし、インストールします。
    2.  ターミナル（PowerShellなど）を開き、以下のコマンドを一度だけ実行します。
        ```bash
        git lfs install
        ```

### 2. `.gitignore` ファイルの作成

-   **目的:** 不要なファイル（ビルド時の中間ファイル、仮想環境フォルダなど）をGitの管理対象から除外し、リポジトリを常にクリーンな状態に保つための設定ファイルです。
-   **手順:**
    1.  プロジェクトフォルダの**一番上の階層**に、`.gitignore` という名前のテキストファイルを作成します。（`.txt`などの拡張子が付かないように注意）
    2.  以下の内容をコピー＆ペーストして保存します。

        ```
        # Python
        __pycache__/
        *.pyc
        venv/
        
        # PyInstaller
        build/
        dist/
        *.spec
        
        # Inno Setup
        Output/
        *.iss
        
        # OS generated files
        .DS_Store
        Thumbs.db
        ```

### 3. Inno Setup のインストール

-   **目的:** PyInstallerで生成したファイル群を、単一で高圧縮な `.exe` 形式のインストーラーにまとめるためのツールです。
-   **手順:**
    1.  [Inno Setupの公式サイト](https://jrsoftware.org/isinfo.php)から安定版をダウンロードし、インストールします。

---

## Part 1: 開発とリリースのサイクル（更新ごとに行う作業）

ここからの手順は、アプリやプラグインを更新して、新しいバージョンをリリースするたびに繰り返し行います。

### ステップ1: コードの編集とテスト

1.  **仮想環境の有効化**
    -   ターミナルを開き、プロジェクトフォルダに移動します。
        ```powershell
        cd path\to\your\X-Grid-Package
        ```
    -   以下のコマンドで、このプロジェクト専用のPython環境を有効化します。
        ```powershell
        .\venv\Scripts\activate
        ```
        *(プロンプトの先頭に `(venv)` と表示されれば成功です)*

2.  **ソースコードの編集**
    -   `X_Grid.py` や `x_grid_styler.py` をエディタで開き、必要な修正や機能追加を行います。
    -   `python X_Grid.py` を実行するなどして、ローカルで十分に動作をテストします。

### ステップ2: 配布ファイルのビルド

1.  **QGISプラグインのzipファイル作成**
    -   `x_grid_styler` フォルダ（`__init__.py`, `x_grid_styler.py`などが入っている）を丸ごとzipで圧縮します。
    -   ファイル名を `x_grid_styler.zip` として、プロジェクトフォルダのトップに保存します。

2.  **本体アプリのビルド (PyInstaller)**
    -   **古いビルドファイルを削除:** `build` フォルダと `dist` フォルダがあれば、手動で削除します。
    -   ターミナルで以下のコマンドを実行します。
        ```powershell
        pyinstaller X_Grid.spec
        ```
    -   `dist` フォルダ内に `X_Grid` という名前のフォルダが生成されます。

### ステップ3: インストーラーの作成 (Inno Setup)

1.  **Inno Setupの起動**
    -   Inno Setupを起動します。
    -   **💡ヒント:** 前回作成したインストーラーの設計図 (`.iss`ファイル) があれば、それを開いて**バージョン番号だけを修正**するのが一番簡単です。

2.  **ウィザードの実行（新規作成の場合）**
    -   `Application version`: 新しいバージョン番号 (例: `1.2.0`) に更新します。
    -   `Application main executable file`: `dist\X_Grid\X_Grid.exe` を指定します。
    -   `Other application files`: **[Add folder...]** ボタンで `dist\X_Grid` フォルダ全体を指定します。
    -   `Setup Install Mode`: **"Non administrative install mode"** を選択します。
    -   `Compiler output base file name`: 新しいバージョン番号を含めた名前にします (例: `X_Grid_v1.2.0_setup`)。

3.  **インストーラーのコンパイル**
    -   メニューの `Build` > `Compile` を実行します。
    -   単一の `.exe` 形式のインストーラーが生成されます。
    -   **重要:** このインストーラーを、プロジェクトフォルダ内の `installer` フォルダに配置します。

### ステップ4: GitHubへのアップロード (Push)

1.  **変更内容の確認 (`git status`)**
    -   ターミナルで `git status` を実行し、変更・追加されたファイルを確認します。

2.  **すべての変更を追加 (`git add`)**
    -   `.gitignore` があるので、安全にすべての変更をステージングできます。
        ```powershell
        git add .
        ```

3.  **変更を記録 (`git commit`)**
    -   変更内容が分かるように、メモを付けてPC内に記録します。
        ```powershell
        git commit -m "feat: バージョン1.2.0の更新 (ここに具体的な変更内容を書く)"
        ```

4.  **GitHubに送信 (`git push`)**
    -   PC内の記録を、インターネット上のGitHubにアップロードします。
        ```powershell
        git push origin main
        ```

    -   **🚨【重要】`push`が失敗 (rejected) した場合の対処法**
        -   `error: failed to push...` というメッセージが表示されたら、それはあなたのPCが知らない変更が先にGitHubに存在するためです。慌てずに以下の手順に進んでください。

    -   **手順A: GitHubの最新の変更を取り込む (`git pull`)**
        ```powershell
        git pull origin main
        ```
        -   **成功した場合:** `Successfully merged...` のようなメッセージが出たら、競合はありませんでした。もう一度 `git push origin main` を実行して、ステップ5に進んでください。
        -   **コンフリクトが発生した場合:** `CONFLICT ...` `Automatic merge failed;` というメッセージが出たら、**手順B**に進んでください。

    -   **手順B: コンフリクト (競合) の解決**
        -   Gitが自動で統合できず、あなたの判断が必要な状態です。
        -   `git status` を実行すると、どのファイルが競合しているか (`Unmerged paths`) がわかります。
        -   競合したファイルごとに、**自分の変更を残すか、相手(GitHub)の変更を残すか**を決定し、以下のコマンドを実行します。

            -   **自分の変更を優先する場合 (例: 自分が削除したなら、削除を正とする)**
                ```powershell
                git checkout --ours "ファイル名"
                ```
            -   **相手(GitHub)の変更を優先する場合 (例: GitHub上の更新版を採用する)**
                ```powershell
                git checkout --theirs "ファイル名"
                ```
            *(例: `取扱説明書.pdf`が競合し、自分の「削除」を優先するなら `git rm 取扱説明書.pdf` を実行します)*

        -   競合ファイルをすべて解決したら、それをGitに伝えます。
            ```powershell
            # 変更を適用したファイルをaddする
            git add . 
            ```

        -   最後に、マージを完了させるためのコミットを実行します。
            ```powershell
            git commit
            ```

    -   **🚨【重要】`git commit`後にVimエディタが開いた場合の対処法**
        -   もしターミナルが下の画像のような画面に切り替わったら、それはVimというエディタが起動した状態です。
        -   これは「マージコミットのメッセージを編集しますか？」と聞かれている状態です。今回は編集不要なので、以下の手順で**保存して終了**します。
        -   **操作手順:** キーボードで **`Esc`** キーを押し、続けて **`:wq`** と入力し、最後に **`Enter`** キーを押します。(`:wq`は「保存して終了」の命令です)

        -   これでローカルの準備が整いました。満を持して、もう一度 `push` します。
            ```powershell
            git push origin main
            ```

### ステップ5: GitHubでのリリース作成（ファイル添付とリンク作成）

ここがリリースの最も重要で、間違いやすいポイントです。慎重に進めましょう。

1.  **配布ファイルの準備【黄金ルール】**
    -   **日本語ファイル名は使用しない！** Webでの互換性のため、配布するファイル名は**半角英数字、ハイフン(-)、アンダースコア(_)のみ**にしてください。
    -   悪い例: `取扱説明書.pdf`
    -   良い例: `X-Grid_manual.pdf`
    -   PC上で事前にファイル名を変更しておきます。

2.  **リリース作成開始**
    -   ブラウザであなたのGitHubリポジトリを開き、右側の **[Releases]** > **[Draft a new release]** をクリックします。

3.  **基本情報の入力**
    -   **Tag version**: 新しいバージョン番号を入力します (例: `v1.2.0`)。
    -   **Release title**: リリースのタイトルを入力します (例: `X-Grid v1.2.0`)。

4.  **リリース内容の記述**
    -   **"Describe this release"** のテキストエリアに、今回の変更点などを記述します。
    -   **この時点では、まだダウンロードリンクは記述しません。**

5.  **配布ファイルの添付**
    -   **"Attach binaries..."** のエリアに、**ステップ1で準備した名前のファイル**をドラッグ＆ドロップします。（例: `X-Grid_v1.2.0_setup.exe`, `x_grid_styler.zip`, `X-Grid_manual.pdf`）

6.  **一度リリースを公開する**
    -   説明文にリンクがないままですが、問題ありません。まず、ページ下部の緑色の **[Publish release]** ボタンを押して、リリースを一度公開します。

7.  **正しいダウンロードURLをコピーする【最重要】**
    -   公開されたリリースの**閲覧ページ**に移動します。
    -   ページ下部の **"Assets"** に、アップロードしたファイルが**青いリンク**で表示されています。
    -   **各ファイル名の上で右クリック**し、**「リンクのアドレスをコピー」**（または「Copy Link Address」など）を選択します。これを**ファイルごと**に行います。

8.  **リリースを再編集して、リンクを完成させる**
    -   リリースページの右上にある**鉛筆マーク（✏️）**をクリックし、**編集画面**に戻ります。
    -   **"Describe this release"** のテキストエリアに、ダウンロード用のセクションを追記し、**ステップ7でコピーしたURL**を貼り付けます。

        ```markdown
        ---
        ### ⬇️ ダウンロードはこちらから ⬇️

        - **X-Grid アプリ (インストーラー):** [X-Grid_v1.2.0_setup.exe](ここにコピーしたexeのURLを貼り付け)
        - **X-Grid Styler プラグイン (zip):** [x_grid_styler.zip](ここにコピーしたzipのURLを貼り付け)
        - **取扱説明書 (PDF):** [X-Grid_manual.pdf](ここにコピーしたpdfのURLを貼り付け)
        ---
        ```
    -   💡 **リンクの仕組み:** `[表示したい文字](完全なURL)` という書き方です。

9.  **最終更新**
    -   すべてのリンクを正しいURLに書き換えたら、ページ下部の緑色の **[Update release]** ボタンを押して完了です。

---

**これで、すべての更新作業は完了です！** 🎉
公開されたページで、ダウンロードリンクが正しく機能することを確認してください。